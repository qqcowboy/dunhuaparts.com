<div class="products-div admin-products" id="admin-products-products">
	<!-- left -->
	<div class="products-left admin-products-left">
		<div class="products-title">
			<span>Categories</span>
		</div>
		<div data-bind="foreach:ListCategories" class="products-tree">
			<div class="item hovdisplay hovbig" data-bind="attr:{title:$data.Remark},css:{'current':$root.SelCategory().ID==$data.ID},click:$root.EventSelCategory">
				<i class="fa fa-chevron-circle-right"></i>
				<span data-bind="text:$data.Name"></span>
				<div class="ctrl">
					<a data-bind="click:$root.EventEditCategory,clickBubble:false"><i class="fa fa-edit"></i></a>
					<a data-bind="click:$root.EventDelCategory,clickBubble:false"><i class="fa fa-remove"></i></a>
				</div>
			</div>
		</div>
		<div data-bind="click:EventAddCategory" class="addcategory hovbig">
			<i class="fa fa-plus-circle"></i>
			添加分类
		</div>
	</div>
	<!-- right -->
	<div class="products-right admin-products-right">
		<div class="products-title aleft">
			<span>Products</span>
			<span data-bind="text:SelCategory().Name">all</span>
			<a class="btn btn-success product-add-btn" data-bind="visible:SelCategory().ID!=undefined" style="display:none;">
 				<i class="fa fa-plus fa-lg"></i> Add
			</a>
		</div>
		<!-- current category -->
		<div data-bind="foreach:ListProducts" class="products-current-list productslist">
			<div class="item" data-bind="fadeVisible:$root.SelCategory().ID==undefined||$data.IndexID==$root.SelCategory().ID,if:$root.SelCategory().ID==undefined||$data.IndexID==$root.SelCategory().ID,click:$root.EventSelProducts">
				<span data-bind="text:$data.Title">Back Cover1</span>
				<img data-bind="attr:{src:$data.Src}"/>
			</div>
		</div>
	</div>
	<div data-bind="attr:{id:DialogID}" ui-dialog="true">
		<div data-bind="if:SelProducts().ID!=undefined">
			<div>
				<span data-bind="text:SelProducts().Title"></span>
			</div>
			<div class="imgdialog">
				<img data-bind="attr:{src:SelProducts().Src}" />
			</div>
		</div>
	</div>
	
	<div data-bind="attr:{id:DialogEditID}" title="添加/编辑分类" class="category-editdialog" style="display:none;">
		<div>
			<span>分类名称</span>
			<input data-bind="value:AttrCategory().Name" type="text"/><br>
			<span class="s2">说明</span>
			<textarea data-bind="value:AttrCategory().Remark" type="text"></textarea>
		</div>
		<div class="btn" data-bind="click:EventSaveCategory">
			<span>保存</span>
		</div>
	</div>
	<script type="text/javascript">
		
		var ctrl = $('#admin-products-products');
		function Products_Products_V1(){
			this.DialogID = cowboy.sys.guid();
			this.DialogEditID = cowboy.sys.guid();
			//selected category
			this.SelCategory = ko.observable({});
			//all categories
			this.ListCategories = ko.observableArray([]);
			this.AttrCategory = ko.observable({Name:'',Remark:''});
			this.ListProducts = ko.observableArray([]);
			this.SelProducts = ko.observable({});
			this.FuncGetCategory = function(callback){
				if(this.funcgetcategory){
					return;
				}
				this.funcgetcategory=true;
				this.ListCategories([]);
				$.ajax({url:'/products/categories',type:'get'}).done(function(data){
					this.funcgetcategory=false;
					if(data.code==1){
						this.ListCategories(data.data);
					}
				}.bind(this)).fail(function(){
					cowboy.views.FuncAddTip('网络出小差了...');
					this.funcgetcategory=false;
				}.bind(this));
			};
			this.EventSelCategory = function(m,e){
				if(this.SelCategory().ID==m.ID){
					return;
				}
				this.SelCategory(m);
			}.bind(this);
			this.EventAddCategory=function(m,e){
				this.AttrCategory({Name:'',Remark:''});
				$('#'+this.DialogEditID).dialog('open');
			}.bind(this);
			this.EventSaveCategory=function(){
				var params={Remark:this.AttrCategory().Remark||'',Name:$.trim(this.AttrCategory().Name||'')};
				if (params.Name.length<1){
					cowboy.views.FuncAddTip('请输入分类名称');
					return;
				}
				if(this.eventsavecategory){
					return;
				}
				this.eventsavecategory=true;
				if(this.AttrCategory().ID==undefined){
					$.ajax({url:'/products/createcategory',data:{data:JSON.stringify(params)},type:'post'}).done(function(data){
						this.eventsavecategory=false;
						if(data.code==1){
							this.FuncGetCategory();
							cowboy.views.FuncAddTip('添加成功');
							$('#'+this.DialogEditID).dialog('close');
						}else{
							cowboy.views.FuncAddTip(data.msg);
						}
					}.bind(this)).fail(function(){
						cowboy.views.FuncAddTip('网络出小差了...');
						this.eventsavecategory=false;
					}.bind(this));
				}else{
					params.ID=this.AttrCategory().ID
					$.ajax({url:'/products/updatecategory',data:{data:JSON.stringify(params)},type:'post'}).done(function(data){
						this.eventsavecategory=false;
						if(data.code==1){
							this.FuncGetCategory();
							cowboy.views.FuncAddTip('更新成功');
							$('#'+this.DialogEditID).dialog('close');
						}else{
							cowboy.views.FuncAddTip(data.msg);
						}
						
					}.bind(this)).fail(function(){
						cowboy.views.FuncAddTip('网络出小差了...');
						this.eventsavecategory=false;
					}.bind(this));
				}
			}.bind(this);
			this.EventSelProducts = function(m,e){
				this.SelProducts(m);
				$('#'+this.DialogID).dialog('open');
			}.bind(this);
			this.EventEditCategory = function(m,e){
				this.AttrCategory(m);
				$('#'+this.DialogEditID).dialog('open');
			}.bind(this);
			this.EventDelCategory = function(m,e){
				var params={ID:m.ID};
				$.ajax({url:'/products/removecategory',data:{data:JSON.stringify(params)},type:'get'}).done(function(data){
					if(data.code==1){
						this.ListCategories.remove(m);
						this.FuncGetCategory();
						cowboy.views.FuncAddTip('删除成功');
					}else{
						cowboy.views.FuncAddTip(data.msg);
					}
				}.bind(this)).fail(function(){
					cowboy.views.FuncAddTip('网络出小差了...');
				}.bind(this));
			}.bind(this);
			this.Init = function(){
				this.FuncGetCategory ();
				$('#'+this.DialogID).dialog({
					autoOpen: false,
					modal:true,
					title:'Product',
					width:910,
					show: {
						effect: "blind",
						duration: 50
					},
					hide: {
						effect: "blind",
						duration: 20
					}
				});
				$('#'+this.DialogEditID).dialog({
					autoOpen: false,
					modal:true,
					width:500,
					height:300,
					show: {
					  effect: "blind",
					  duration: 20
					},
					hide: {
					  effect: "explode"
					}
				});
			};
			this.Bindings=function(ctrl){
				ko.applyBindings(this,ctrl);
				this.Init();
			};
		};
		var products_Products_V1 = new Products_Products_V1();
		products_Products_V1.Bindings(ctrl[0]);
	</script>
</div>
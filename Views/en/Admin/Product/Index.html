<div class="products-div admin-products" id="admin-products-products">
	<!-- left -->
	<div class="products-left admin-products-left">
		<div class="products-title">
			<span>Categories</span>
		</div>
		<div data-bind="foreach:ListCategories" class="products-tree">
			<div class="item hovdisplay hovbig" data-bind="attr:{title:$data.Remark},css:{'current':$root.SelCategory().ID==$data.ID},click:$root.EventSelCategory">
				<i class="fa fa-chevron-circle-right"></i>
				<div class="name"><span data-bind="text:$root.AttrLang()==0?$data.Name:$data.NameCN"></span></div>
				<div class="ctrl">
					<a data-bind="click:$root.EventEditCategory,clickBubble:false" title="编辑分类信息"><i class="fa fa-edit"></i></a>
					<a data-bind="click:$root.EventDelCategory,clickBubble:false" title="删除分类"><i class="fa fa-remove"></i></a>
				</div>
			</div>
		</div>
		<div data-bind="click:EventAddCategory" class="addcategory hovbig">
			<i class="fa fa-plus-circle"></i>
			添加分类
		</div>
	</div>
	<!-- right -->
	<div class="products-right admin-products-right">
		<div class="products-title aleft">
			<span>Products</span>
			<span data-bind="text:AttrLang()==0?SelCategory().Name:SelCategory().NameCN">all</span>
			<a class="btn btn-success product-add-btn" data-bind="visible:SelCategory().ID!=undefined,click:EventAddProduct" style="display:none;">
 				<i class="fa fa-plus fa-lg"></i> Add
			</a>
			<a class="btn btn-success product-lang-btn" data-bind="click:EventLang">
				<i class="fa fa-eye fa-lg"></i>
 				<span data-bind="text:AttrLang()==0?'英文':'中文'">中文/英文</span>
			</a>
		</div>
		<!-- current category -->
		<div data-bind="foreach:ListProducts" class="row grid productslist">
			<div class="col-sm-3 col-md-2 grid-item item" data-bind="click:$root.EventSelProducts">
				<div class="thumbnail">
					<i data-bind="visible:$data.ExtType==1" class="label label-warning fa-lg hometag" style="display:none;">首页大图</i>
					<img data-bind="attr:{src:'/img/product/3?id='+$data.Images[0]}">
					<div class="caption">
						<h3 data-bind="text:$root.AttrLang()==0?$data.Title:$data.TitleCN"></h3>
						<p data-bind="text:$root.AttrLang()==0?$data.Remark:$data.RemarkCN"></p>
					</div>
					<div class="hovshow" style="display:none;">
						<a data-bind="click:$root.EventEditProduct,clickBubble:false" title="编辑"><i class="fa fa-edit fa-lg"></i></a>
						<a data-bind="click:$root.EventDelProduct,clickBubble:false" title="删除"><i class="fa fa-remove fa-lg"></i></a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 浏览产品弹出层 -->
	<div data-bind="attr:{id:DialogID}" ui-dialog="true">
		<div data-bind="if:SelProduct().ID!=undefined">
			<div>
				<span data-bind="text:SelProduct().Title"></span>
			</div>
			<div  class="imgdialog">
				<img data-bind="attr:{src:'/img/product?id='+SelProduct().Images[0]}" />
			</div>
		</div>
	</div>
	<!-- 分类编辑弹出层 -->
	<div data-bind="attr:{id:DialogEditID}" title="添加/编辑分类" class="category-editdialog" style="display:none;">
		<div>
			<div class="input-group input-group-lg item">
				  <span class="input-group-addon" id="sizing-addon1">名称 <span class="label label-primary">英文</span></span>
				  <input type="text" class="form-control" data-bind="value:AttrCategory().Name" aria-describedby="sizing-addon1">
			</div>
			<div class="input-group input-group-lg item">
				  <span class="input-group-addon" id="sizing-addon2">名称 <span class="label label-info">中文</span></span>
				  <input type="text" class="form-control" data-bind="value:AttrCategory().NameCN" aria-describedby="sizing-addon2">
			</div>
			<div class="input-group input-group-lg item">
				  <span class="input-group-addon" id="sizing-addon3">说明 <span class="label label-primary">英文</span></span>
				  <textarea type="text" class="form-control" data-bind="value:AttrCategory().Remark" aria-describedby="sizing-addon3"></textarea>
			</div>
			<div class="input-group input-group-lg item">
				  <span class="input-group-addon" id="sizing-addon4">说明 <span class="label label-info">中文</span></span>
				  <textarea type="text" class="form-control" data-bind="value:AttrCategory().RemarkCN" aria-describedby="sizing-addon4"></textarea>
			</div>
		</div>
		<div class="btn" data-bind="click:EventSaveCategory">
			<span>保存</span>
		</div>
	</div>
	<!-- 产品编辑弹出层 -->
	<div data-bind="attr:{id:DialogEdit1ID}" title="添加/编辑产品" class="category-editdialog" style="display:none;">
		<div>
			<div class="input-group input-group-lg item">
				  <span class="input-group-addon" id="sizing-addon1">名称 <span class="label label-primary">英文</span></span>
				  <input type="text" class="form-control" data-bind="value:AttrProduct().Title" aria-describedby="sizing-addon1">
			</div>
			<div class="input-group input-group-lg item">
				  <span class="input-group-addon" id="sizing-addon2">名称 <span class="label label-info">中文</span></span>
				  <input type="text" class="form-control" data-bind="value:AttrProduct().TitleCN" aria-describedby="sizing-addon2">
			</div>
			<div class="input-group input-group-lg item">
				  <span class="input-group-addon" id="sizing-addon3">说明 <span class="label label-primary">英文</span></span>
				  <textarea type="text" class="form-control" data-bind="value:AttrProduct().Remark" aria-describedby="sizing-addon3"></textarea>
			</div>
			<div class="input-group input-group-lg item">
				  <span class="input-group-addon" id="sizing-addon4">说明 <span class="label label-info">中文</span></span>
				  <textarea type="text" class="form-control" data-bind="value:AttrProduct().RemarkCN" aria-describedby="sizing-addon4"></textarea>
			</div>
			<div class="input-group input-group-lg item">
				<span class="input-group-addon">
					<input data-bind="checked:AttrProduct().UI_ExtType()==1,event:{'change':EventShowBig}" type="checkbox">
				</span>
				<span class="form-control">是否首页大图</span>
			</div>
			<div class="left">
				<span>产品图片</span>
			</div>
			<div class="right editimg" data-bind="visible:AttrProduct().UI_Image().length<AttrImgLimit">
				<input type="file" accept="image/*" data-bind="event:{'change':EventUpImg}"/>
			</div>
			<div class="right editimg" data-bind="visible:AttrProduct().UI_Image().length>0,foreach:AttrProduct().UI_Image">
				<img data-bind="attr:{src:$data.Data||'/img/product?id='+$data.ID}" />
				<button data-bind="click:$root.EventDelImg" class="btn-del" type="button" style="display:none;"><i class="fa fa-trash-o fa-lg"></i></button>
			</div>
		</div>
		<div class="btn" data-bind="click:EventSaveProduct">
			<span>保存</span>
		</div>
	</div>
	<!-- 删除分类提醒 -->
	<div data-bind="attr:{id:DialogDelID}" style="display:none;text-align:center;">
		<div style="color:red;margin-bottom:20px;">
			<b>注意，删除分类将同时删除分类下的产品</b>
		</div>
		<button data-bind="click:EventCanDel" class="btn btn-default btn-lg" type="button">取消</button>
		<span>&nbsp;</span>
		<button data-bind="click:EventSureDel" class="btn btn-danger btn-lg" type="button"><i class="fa fa-remove"></i>删除</button>
	</div>
	<script type="text/javascript">
		var ctrl = $('#admin-products-products');
		function Products_Products_V1(){
			this.DialogID = cowboy.sys.guid();
			this.DialogEditID = cowboy.sys.guid();
			this.DialogEdit1ID = cowboy.sys.guid();
			this.DialogDelID = cowboy.sys.guid();
			//selected category
			this.SelCategory = ko.observable({});
			//all categories
			this.ListCategories = ko.observableArray([]);
			this.AttrCategory = ko.observable({Name:'',Remark:'',NameCN:'',RemarkCN:''});
			this.TmpCategory={};
			//  UI_Image:[{ID,Data}]
			this.AttrProduct = ko.observable({Title:'',Remark:'',TitleCN:'',RemarkCN:'',UI_ExtType:ko.observable(0),UI_Image:ko.observableArray([])});
			this.ListProducts = ko.observableArray([]);
			this.AttrLimitProducts = 50;
			this.AttrLang = ko.observable(0);
			this.AttrImgLimit = 1; 
			this.AttrmasonryOptions = {itemSelector: '.grid-item',
				columnWidth:20,
				fitWidth: false
			};
			this.Attrmasonry={};
			this.SelProduct = ko.observable({});
			this.FuncMasonry=function(){
				try{
					this.Attrmasonry.masonry('destroy');
				}catch(e){console.log(e);}
				this.Attrmasonry.masonry( this.AttrmasonryOptions );
				this.Attrmasonry.imagesLoaded().progress( function() {
				 	this.Attrmasonry.masonry('layout');
				}.bind(this));
			}
			this.FuncGetProducts = function(start,limit,categoryid,callback){
				if(this.funcgetproducts){
					return;
				}
				var params={Start:start,Limit:limit,CategoryID:categoryid};
				this.funcgetproducts=true;
				this.ListProducts([]);
				$.ajax({url:'/products/query',data:{data:JSON.stringify(params)},type:'post'}).done(function(data){
					this.funcgetproducts=false;
					if(data.code==1){
						this.ListProducts(data.data);
						this.FuncMasonry();
					}
				}.bind(this)).fail(function(){
					cowboy.views.FuncAddTip('网络出小差了...');
					this.funcgetproducts=false;
				}.bind(this));
			};
			this.FuncGetCategory = function(callback){
				if(this.funcgetcategory){
					return;
				}
				this.funcgetcategory=true;
				this.ListCategories([]);
				$.ajax({url:'/products/categories',type:'get'}).done(function(data){
					this.funcgetcategory=false;
					if(data.code==1){
						this.ListCategories(data.data);
					}
				}.bind(this)).fail(function(){
					cowboy.views.FuncAddTip('网络出小差了...');
					this.funcgetcategory=false;
				}.bind(this));
			};
			this.EventLang = function(){
				this.AttrLang(this.AttrLang()==0?1:0);
			};
			this.EventAddProduct=function(m,e){
				this.AttrProduct({Title:'',Remark:'',TitleCN:'',RemarkCN:'',UI_ExtType:ko.observable(0),UI_Image:ko.observableArray([])});
				$('#'+this.DialogEdit1ID).dialog('open');
			}.bind(this);
			this.EventAddCategory=function(m,e){
				this.AttrCategory({Name:'',Remark:'',NameCN:'',RemarkCN:''});
				$('#'+this.DialogEditID).dialog('open');
			}.bind(this);
			this.EventSaveProduct=function(){
				var params={Remark:this.AttrProduct().Remark||'',RemarkCN:this.AttrProduct().RemarkCN||'',Title:$.trim(this.AttrProduct().Title||''),TitleCN:$.trim(this.AttrProduct().TitleCN||'')};
				if (params.Title.length<1){
					cowboy.views.FuncAddTip('请输入名称');
					return;
				}
				if (params.TitleCN.length<1){
					cowboy.views.FuncAddTip('请输入中文名称');
					return;
				}
				params.Images=[];
				$.each(this.AttrProduct().UI_Image(),function(i,item){
					if(item.ID==undefined||item.ID.length<1){
						return true;
					}
					params.Images.push(item.ID);
				});
				if (params.Images.length<1){
					cowboy.views.FuncAddTip('需要上传产品图片');
					return;
				}
				if(this.eventsaveproduct){
					return;
				}
				this.eventsaveproduct=true;
				params.ExtType=this.AttrProduct().UI_ExtType();
				if(this.AttrProduct().ID==undefined){
					params.CategoryID=this.SelCategory().ID;
					if(params.Images.length<1){
						this.eventsaveproduct=false;
						cowboy.views.FuncAddTip('请上传图片');
						return;
					}
					$.ajax({url:'/products/create',data:{data:JSON.stringify(params)},type:'post'}).done(function(data){
						this.eventsaveproduct=false;
						if(data.code==1){
							var tmp = data.data;
							tmp.UI_ExtType=ko.observable(tmp.ExtType);
							var tmpimg=[];
							$.each(tmp.Images,function(i,item){
								tmpimg.push({ID:item,Data:''});
							});
							tmp.UI_Image = ko.observableArray(tmpimg);
							this.ListProducts.unshift(tmp);
							this.FuncMasonry();
							cowboy.views.FuncAddTip('添加成功');
							$('#'+this.DialogEdit1ID).dialog('close');
						}else{
							cowboy.views.FuncAddTip(data.msg);
						}
					}.bind(this)).fail(function(){
						cowboy.views.FuncAddTip('网络出小差了...');
						this.eventsaveproduct=false;
					}.bind(this));
				}else{
					params.ID=this.AttrProduct().ID
					$.ajax({url:'/products/update',data:{data:JSON.stringify(params)},type:'post'}).done(function(data){
						this.eventsaveproduct=false;
						if(data.code==1){
							this.FuncGetProducts(-1,this.AttrLimitProducts,this.SelCategory().ID);
							cowboy.views.FuncAddTip('更新成功');
							$('#'+this.DialogEdit1ID).dialog('close');
						}else{
							cowboy.views.FuncAddTip(data.msg);
						}
						
					}.bind(this)).fail(function(){
						cowboy.views.FuncAddTip('网络出小差了...');
						this.eventsaveproduct=false;
					}.bind(this));
				}
			};
			this.EventSelCategory = function(m,e){
				if(this.SelCategory().ID==m.ID){
					return;
				}
				this.SelCategory(m);
				this.FuncGetProducts(-1,this.AttrLimitProducts,m.ID);
			}.bind(this);
			this.EventAddCategory=function(m,e){
				this.AttrCategory({Name:'',Remark:'',NameCN:'',RemarkCN:''});
				$('#'+this.DialogEditID).dialog('open');
			}.bind(this);
			this.EventSaveCategory=function(){
				var params={Remark:this.AttrCategory().Remark||'',RemarkCN:this.AttrCategory().RemarkCN||'',Name:$.trim(this.AttrCategory().Name||''),NameCN:$.trim(this.AttrCategory().NameCN||'')};
				if (params.Name.length<1){
					cowboy.views.FuncAddTip('请输入分类名称');
					return;
				}
				if (params.NameCN.length<1){
					cowboy.views.FuncAddTip('请输入分类中文名称');
					return;
				}
				if(this.eventsavecategory){
					return;
				}
				this.eventsavecategory=true;
				if(this.AttrCategory().ID==undefined){
					$.ajax({url:'/products/createcategory',data:{data:JSON.stringify(params)},type:'post'}).done(function(data){
						this.eventsavecategory=false;
						if(data.code==1){
							this.FuncGetCategory();
							cowboy.views.FuncAddTip('添加成功');
							$('#'+this.DialogEditID).dialog('close');
						}else{
							cowboy.views.FuncAddTip(data.msg);
						}
					}.bind(this)).fail(function(){
						cowboy.views.FuncAddTip('网络出小差了...');
						this.eventsavecategory=false;
					}.bind(this));
				}else{
					params.ID=this.AttrCategory().ID
					$.ajax({url:'/products/updatecategory',data:{data:JSON.stringify(params)},type:'post'}).done(function(data){
						this.eventsavecategory=false;
						if(data.code==1){
							this.FuncGetCategory();
							cowboy.views.FuncAddTip('更新成功');
							$('#'+this.DialogEditID).dialog('close');
						}else{
							cowboy.views.FuncAddTip(data.msg);
						}
						
					}.bind(this)).fail(function(){
						cowboy.views.FuncAddTip('网络出小差了...');
						this.eventsavecategory=false;
					}.bind(this));
				}
			}.bind(this);
			this.EventSelProducts = function(m,e){
				this.SelProduct(m);
				$('#'+this.DialogID).dialog('open');
			}.bind(this);
			this.EventEditProduct = function(m,e){
				m.UI_ExtType=ko.observable(m.ExtType);
				var tmp=[];
				$.each(m.Images,function(i,item){
					tmp.push({ID:item,Data:''});
				});
				m.UI_Image=ko.observableArray(tmp);
				this.AttrProduct(m);
				$('#'+this.DialogEdit1ID).dialog('open');
			}.bind(this);
			this.EventDelProduct = function(m,e){
				var params={ID:[m.ID]};
				$.ajax({url:'/products/remove',data:{data:JSON.stringify(params)},type:'get'}).done(function(data){
					if(data.code==1){
						this.ListProducts.remove(m);
						this.Attrmasonry.masonry('layout');
						cowboy.views.FuncAddTip('删除成功');
					}else{
						cowboy.views.FuncAddTip(data.msg);
					}
				}.bind(this)).fail(function(){
					cowboy.views.FuncAddTip('网络出小差了...');
				}.bind(this));
			}.bind(this);
			this.EventEditCategory = function(m,e){
				this.AttrCategory(m);
				$('#'+this.DialogEditID).dialog('open');
			}.bind(this);
			this.EventCanDel = function(){
				this.TmpCategory={};
				$('#'+this.DialogDelID).dialog('close');
			};
			this.EventShowBig = function(m,e){
				this.AttrProduct().UI_ExtType(this.AttrProduct().UI_ExtType()==0?1:0);
			};
			this.EventDelImg = function(m,e){
				this.AttrProduct().UI_Image.remove(m);
			}.bind(this);
			this.EventUpImg = function(m,e){
				var ctrl = $(e.target);
				cowboy.func.img_handle(ctrl[0],function(data){
					ctrl.val('');
					if(data==''){
						cowboy.views.FuncAddTip('图片上传失败');
						return;
					}
					$.ajax({url:'/products/addproductimg',type:'post',dataType:'json',data:{data:JSON.stringify({ProductID:this.AttrProduct().ID,Image:data})}}).done(function(result){
						if(result.code==1){
							this.AttrProduct().UI_Image.push({ID:result.data,Data:''});
						}else{
							cowboy.views.FuncAddTip(result.msg);
						}
					}.bind(this)).fail(function(){
						cowboy.views.FuncAddTip('网络出小差了...');
					});
				}.bind(this),800);
			};
			this.EventSureDel = function(){
				m=this.TmpCategory;
				if(m==this.SelCategory()){
					this.SelCategory('');
					this.ListProducts([]);
				}
				var params={ID:m.ID};
				$.ajax({url:'/products/removecategory',data:{data:JSON.stringify(params)},type:'get'}).done(function(data){
					if(data.code==1){
						this.ListCategories.remove(m);
						cowboy.views.FuncAddTip('删除成功');
						$('#'+this.DialogDelID).dialog('close');
					}else{
						cowboy.views.FuncAddTip(data.msg);
					}
				}.bind(this)).fail(function(){
					cowboy.views.FuncAddTip('网络出小差了...');
				}.bind(this));
			};
			this.EventDelCategory = function(m,e){
				this.TmpCategory=m;
				$('#'+this.DialogDelID).dialog('open');
			}.bind(this);
			this.Init = function(){
				this.Attrmasonry = $('.grid').masonry( this.AttrmasonryOptions );
				this.FuncGetCategory(function(){
					
				}.bind(this));
				$('#'+this.DialogID).dialog({
					autoOpen: false,
					modal:true,
					title:'Product',
					width:910,
					position:{ my: "top", at: "top", of: window },
					show: {
						effect: "blind",
						duration: 50
					},
					hide: {
						effect: "blind",
						duration: 20
					}
				});
				$('#'+this.DialogEditID).dialog({
					autoOpen: false,
					modal:true,
					width:580,
					height:500,
					show: {
					  effect: "blind",
					  duration: 20
					},
					hide: {
					  effect: "explode"
					}
				});
				$('#'+this.DialogEdit1ID).dialog({
					autoOpen: false,
					modal:true,
					width:580,
					height:700,
					show: {
					  effect: "blind",
					  duration: 20
					},
					hide: {
					  effect: "explode"
					}
				});	
				$('#'+this.DialogDelID).dialog({
					title:"注意",
					autoOpen: false,
					modal:true,
					show: {
					  effect: "blind",
					  duration: 20
					},
					hide: {
					  effect: "explode",
					  duration: 200
					}
				});			
			};
			this.Bindings=function(ctrl){
				ko.applyBindings(this,ctrl);
				this.Init();
			};
		};
		var products_Products_V1 = new Products_Products_V1();
		products_Products_V1.Bindings(ctrl[0]);
	</script>
</div>